<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overlay</title>
    <style>
        [hidden] {
            display: none !important;
        }

        body {
            background: black;
            background-size: cover;
            background-repeat: no-repeat;
            color: #fff;
            display: flex;
            font-family: sans-serif;
            justify-content: center;
            margin: 0;
        }

        .alert {
            display: inline-block;
            max-width: 256px;
        }

        .alert-msg {
            overflow: hidden;
            text-align: center;
            text-overflow: ellipsis;
            text-shadow:
                -1px -1px 0.5px #000,
                 1px -1px 0.5px #000,
                -1px  1px 0.5px #000,
                 1px  1px 0.5px #000;
        }

        .alert-source,
        .alert-amount {
            color: purple;
            white-space: nowrap;
        }

        .msg-text {
            font-size: 2em;

            display: inline-block;
            max-width: 256px;

            overflow: hidden;
            text-align: center;
            text-overflow: ellipsis;
            text-shadow:
                -1px -1px 0.5px #000,
                 1px -1px 0.5px #000,
                -1px  1px 0.5px #000,
                 1px  1px 0.5px #000;
        }
    </style>
</head>
<body>
    <div class="alert-container">
        <div class="alert follow-alert">
            <img class="alert-animation" src="alerts/follow-animation.gif">
            <h2 class="alert-msg">
                <span class="alert-source">PhutbotPhutbot</span>
                is&nbsp;now&nbsp;following!
            </h2>
        </div>
        <div class="alert sub-alert">
            <img class="alert-animation" src="alerts/follow-animation.gif">
            <h2 class="alert-msg">
                <span class="alert-source">Phutbot</span>
                just&nbsp;subscribed!
            </h2>
        </div>
        <div class="alert bit-alert">
            <img class="alert-animation" src="alerts/follow-animation.gif">
            <h2 class="alert-msg">
                <span class="alert-source">Phutbot</span>
                cheered!&nbsp;x<span class="alert-amount">1000</span>
            </h2>
        </div>
        <div class="alert host-alert">
            <img class="alert-animation" src="alerts/follow-animation.gif">
            <h2 class="alert-msg">
                <span class="alert-source">Phutbot</span>
                is hosting with a party&nbsp;of&nbsp;<span class="alert-amount">11</span>!
            </h2>
        </div>
        <div class="alert raid-alert">
            <img class="alert-animation" src="alerts/follow-animation.gif">
            <h2 class="alert-msg">
                <span class="alert-source">Phutbot</span>
                is raiding with a party&nbsp;of&nbsp;<span class="alert-amount">11</span>!
            </h2>
        </div>
    </div>

    <div class="msg-box" hidden>
        <span class="msg-text">Phutbot</span>
    </div>

    <script type="module">
        class AlertBox {
            constructor(el) {
                this._el = el;
                this._anim = Array.from(this._el.getElementsByClassName('alert-animation'));
                this._msg = Array.from(this._el.getElementsByClassName('alert-msg'));
                this._src = Array.from(this._el.getElementsByClassName('alert-source'));
                this._amnt = Array.from(this._el.getElementsByClassName('alert-amount'));
            }

            get container() { return this._el; }
            get type() { return this._type; }
            get anim() { return this._anim; }
            get msg() { return this._msg; }
            get src() { return this._src; }
            get amnt() { return this._amnt; }
            
            toggle() {
                if (this.container.hasAttribute('hidden')) {
                    this.show();
                } else {
                    this.hide();
                }
            }

            show() {
                this.container.removeAttribute('hidden');
            }

            hide() {
                this.container.setAttribute('hidden', '');
            }

            instanceOf(type) {
                return this.container.classList.contains(`${type}-alert`)
            }
        }

        const msgbox = document.getElementsByClassName('msg-box')[0];
        const msgtext = document.getElementsByClassName('msg-text')[0];
        const alertboxes = Array.from(document.getElementsByClassName('alert'))
            .map(el => new AlertBox(el));

        function HideAlerts(type) {
            alertboxes
                .forEach(alertbox => alertbox.hide());
        }

        function ShowAlert(type, src, amnt=0) {
            alertboxes
                .filter(alertbox => alertbox.instanceOf(type))
                .forEach(alertbox => {
                    alertbox.src.forEach(srcEl => srcEl.innerText = src);
                    alertbox.amnt.forEach(amntEl => amntEl.innerText = amnt);
                    alertbox.show()
                });
        }

        function ShowMsg(text) {
            msgtext.innerText = text;
            msgbox.removeAttribute('hidden');
        }

        function HideMsg() {
            msgbox.setAttribute('hidden', '');
        }

        HideMsg();
        HideAlerts();

        let alertTimeout = null;
        let alertQueue = [];
        let alertHandler = () => {
            let json = alertQueue.shift();

            HideAlerts();
            setTimeout(() => {
                ShowAlert(json.alertType, json.target, json.count);
            }, 500);
            
            if (alertQueue.length > 0) {
                alertTimeout = setTimeout(alertHandler, json.timeout + 500);
            } else {
                setTimeout(HideAlerts, json.timeout);
                alertTimeout = null;
            }
        };

        // ShowMsg('test');
        // ShowAlert('follow', 'TestUser', 112);

        const socket = new WebSocket('ws://10.10.0.88:8090/');
        socket.addEventListener('open', (event) => {
            for (let i = 0; i < 5; ++i) {
                socket.send('msg' + i);
            }
            ShowMsg('opn');
        });
        
        socket.addEventListener('message', (event) => {
            console.log(event.data);
            const json = JSON.parse(event.data);
            switch (json.type) {
                case 'alert':
                    alertQueue.push(json);
                    if (alertTimeout === null)
                        alertTimeout = setTimeout(alertHandler, 500);
                    break;
                case 'msg':
                    ShowMsg(json.target);
                    break;
            }
        });
    </script>
</body>
</html>